# [κ³µμ‹] λΉ„λ””μ¤ μ²λ¦¬, λ³΄μ• μ¬μƒ λ° μ¤ν”„λΌμΈ μ›ν¬ν”λ΅μ° (v5.3 FINAL)

**λ©ν‘:** v5.2μ μ•μ •μ μΈ μ¤νΈλ¦¬λ° κΈ°λ° μ„μ—, **μ™„μ „ν• μ¤ν”„λΌμΈ μ¬μƒ κ²½ν—**κ³Ό **κ°•ν™”λ μ μ¶ μ¶”μ  κΈ°λ¥(μ›ν„°λ§ν¬)**μ„ ν†µν•©ν•μ—¬, λΉ„-DRM ν™κ²½μ—μ„ κµ¬ν„ κ°€λ¥ν• μµκ³  μμ¤€μ μ‚¬μ©μ κ²½ν—κ³Ό λ³΄μ• λ¨λΈμ„ μ™„μ„±ν•λ‹¤.

---

## 1. λ²„μ „ νμ¤ν† λ¦¬

- **v5.3 (FINAL): True Offline & Dynamic Watermark**
  - `v5.3.0` (κµ¬ν„) μ¤ν”„λΌμΈ λ‹¤μ΄λ΅λ“ λ° 7μΌ λ§λ£ λΌμ΄μ„ μ¤ μ¬μƒ λ΅μ§ μ „μ²΄ κµ¬ν„.
  - `v5.3.0` (κµ¬ν„) μ¨λΌμΈ/μ¤ν”„λΌμΈ μ¬μƒ μ‹ λ™μ  μ›ν„°λ§ν¬ λ λ”λ§ λ° μ„ν— μ μ‘ν• κ°•λ„ μ΅°μ  κΈ°λ¥ μ¶”κ°€.
- **v5.2.x:** True Streaming & Stability Patches
  - `v5.2.7` (κµ¬ν„) μƒνƒ λ¨Έμ‹  νƒ€μ„μ•„μ›ƒ λ° κ²½μ μƒνƒ λ°©μ§€ κ·μΉ™ κ°•μ . λ””λ²„κ·Έ λ΅κΉ… μ‹μ¤ν… λ„μ….
  - `v5.2.4` (κµ¬ν„) μ¤ν”„λΌμΈ λΌμ΄μ„ μ¤ ν‚¤ μ¤μ½”ν”„ μ •μ‹ λ¶„λ¦¬ λ° κ²€μ¦.
  - `v5.2.3` (κµ¬ν„) λ‹¨μΌ μ²­ν¬ μ†μƒ μ‹ λ¶€λ¶„ λ³µκµ¬(μ¬μ‹λ„) λ΅μ§ λ„μ….
  - `v5.2.1` (κµ¬ν„) HTTP Range μ”μ²­ κΈ°λ° Chunk-on-Demand μ¤νΈλ¦¬λ° λ„μ….
- **v5.1.x:** μ•μ •μ„± κ°•ν™” (Fail-Fast, Worker μƒλ…μ£ΌκΈ° μ •μ λ“±)
- **v5.0:** μ¤νΈλ¦¬λ° μ•„ν‚¤ν…μ² κµμ²΄ (Robust Chunked AES-GCM)

---

## 2. v5.3 μ•„ν‚¤ν…μ² ν•µμ‹¬: μ¨λΌμΈκ³Ό μ¤ν”„λΌμΈμ ν†µν•© νμ΄ν”„λΌμΈ

v5.3μ€ μ¨λΌμΈ μ¤νΈλ¦¬λ°κ³Ό μ¤ν”„λΌμΈ μ¬μƒμ΄ λ™μΌν• μ•”νΈν™” νμΌ(`.lsv`)κ³Ό λ³µνΈν™” λ΅μ§(Web Worker)μ„ κ³µμ ν•μ§€λ§, **ν‚¤ λ°κΈ‰ λ‹¨κ³„μ—μ„ μ•”νΈν•™μ μΌλ΅ μ™„λ²½ν λ¶„λ¦¬**λλ” ν•μ΄λΈλ¦¬λ“ λ¨λΈμ„ μ±„νƒν•λ‹¤.

```
[Client App]
     |
     +-- (Online) --β†’ /api/play-session --β†’ [ONLINE Key (λ‹¨κΈ° μ ν¨)]
     |                                          |
     +-- (Offline) -β†’ /api/offline-license β†’ [OFFLINE Key (7μΌ μ ν¨, κΈ°κΈ° λ°”μΈλ”©)]
     |                                          |
     β†“                                          β†“
[Video Player] --(Key, .lsv URL/Buffer)--> [Web Worker]
     |                                          | (λ™μΌν• λ³µνΈν™” λ΅μ§)
     |                                          β†“
     +------------------------------------ [Decrypted MP4 Chunks]
     |                                          |
     β†“                                          β†“
[MediaSource] β†--------------------------- [Append Buffer]
     |
     β†“
[<video> Element]
     +
[Watermark Overlay (seed κΈ°λ°)]
```

### 2.1. μ¨λΌμΈ μ¤νΈλ¦¬λ° (v5.2 κ³„μΉ)
-   `Chunk Offset Map`μ„ μ‚¬μ©ν• **True Streaming Seek**λ¥Ό κ·Έλ€λ΅ μ μ§€ν•μ—¬ λΉ λ¥Έ λ΅λ”©κ³Ό νƒμƒ‰μ„ λ³΄μ¥ν•λ‹¤.
-   λ‹¨μΌ μ²­ν¬ μ†μƒ μ‹ **λ¶€λ¶„ λ³µκµ¬(μ¬μ‹λ„)** λ΅μ§μ΄ λ™μΌν•κ² λ™μ‘ν•λ‹¤.
-   `play-session` APIλ¥Ό ν†µν•΄ λ°κΈ‰λ **λ‹¨κΈ° μ ν¨ μ„Έμ… ν‚¤**λ§μ„ μ‚¬μ©ν•λ‹¤.

### 2.2. μ¤ν”„λΌμΈ λ‹¤μ΄λ΅λ“ λ° μ¬μƒ (v5.3 μ‹ κ·)

**[λ‹¤μ΄λ΅λ“ λ‹¨κ³„]**
1.  **κ¶ν• ν™•μΈ λ° κ³µκ°„ ν™•λ³΄:** μ‚¬μ©μκ°€ λ‹¤μ΄λ΅λ“ λ²„νΌμ„ λ„λ¥΄λ©΄, μ„λ²„λ” ν•΄λ‹Ή μμƒμ— λ€ν• μ‚¬μ©μμ κµ¬λ…/κµ¬λ§¤ μƒνƒλ¥Ό ν™•μΈν•λ‹¤. λ™μ‹μ— ν΄λΌμ΄μ–ΈνΈλ” `navigator.storage.estimate()`λ¥Ό ν†µν•΄ μ¶©λ¶„ν• μ €μ¥ κ³µκ°„μ΄ μλ”μ§€ ν™•μΈν•λ‹¤.
2.  **μ¤ν”„λΌμΈ λΌμ΄μ„ μ¤ λ°κΈ‰:** ν΄λΌμ΄μ–ΈνΈλ” `/api/offline-license`λ¥Ό νΈμ¶ν•λ‹¤. μ„λ²„λ” **7μΌ λ§λ£ μ‹κ°„**κ³Ό **λ””λ°”μ΄μ¤ ID**λ¥Ό ν¬ν•¨ν• HKDF `info` κ°’μ„ μ‚¬μ©ν•μ—¬ **μ¤ν”„λΌμΈ μ „μ© ν‚¤**λ¥Ό νμƒν•κ³ , `watermarkSeed`μ™€ ν•¨κ» λΌμ΄μ„ μ¤ κ°μ²΄λ¥Ό μƒμ„±ν•μ—¬ λ°ν™ν•λ‹¤.
3.  **μ•”νΈν™” νμΌ λ‹¤μ΄λ΅λ“:** ν΄λΌμ΄μ–ΈνΈλ” `/api/video-url`μ„ ν†µν•΄ λ°›μ€ Signed URLλ΅ **μ „μ²΄ `.lsv` νμΌ**μ„ λ‹¤μ΄λ΅λ“ν•λ‹¤.
4.  **IndexedDB μ €μ¥:** λ‹¤μ΄λ΅λ“λ `.lsv` νμΌ(ArrayBuffer)κ³Ό λ°κΈ‰λ°›μ€ μ¤ν”„λΌμΈ λΌμ΄μ„ μ¤ κ°μ²΄λ¥Ό **ν•λ‚μ λ μ½”λ“λ΅ λ¬¶μ–΄ IndexedDBμ— μ €μ¥**ν•λ‹¤. ν‰λ¬Έ λΉ„λ””μ¤ λ°μ΄ν„°λ” λ””μ¤ν¬μ— μ λ€ μ €μ¥λμ§€ μ•λ”λ‹¤.

**[μ¤ν”„λΌμΈ μ¬μƒ λ‹¨κ³„]**
1.  **λΌμ΄μ„ μ¤ κ²€μ¦:** ν”λ μ΄μ–΄λ” IndexedDBμ—μ„ λΌμ΄μ„ μ¤λ¥Ό λ΅λ“ν•μ—¬ λ‹¤μμ„ κ²€μ¦ν•λ‹¤.
    -   `scope`κ°€ `OFFLINE_PLAYBACK`μΈμ§€ ν™•μΈ.
    -   `expiresAt`μ΄ ν„μ¬ μ‹κ°„ μ΄ν›„μΈμ§€ ν™•μΈ (λ§λ£ μ—¬λ¶€).
    -   (μ„ νƒ) `lastCheckedAt`κ³Ό ν„μ¬ μ‹κ°„μ„ λΉ„κµν•μ—¬ μ‹μ¤ν… μ‹κ°„ μ΅°μ‘ μ—¬λ¶€ νƒμ§€.
2.  **Workerλ΅ λ°μ΄ν„° μ „μ†΅:** κ²€μ¦μ„ ν†µκ³Όν•λ©΄, IndexedDBμ—μ„ μ½μ–΄μ¨ `.lsv` νμΌ `ArrayBuffer`μ™€ μ¤ν”„λΌμΈ ν‚¤λ¥Ό Web Workerλ΅ μ§μ ‘ μ „μ†΅ν•λ‹¤. (λ„¤νΈμ›ν¬ μ”μ²­ μ—†μ)
3.  **λ³µνΈν™” λ° μ¬μƒ:** Workerλ” μ¨λΌμΈ μ¤νΈλ¦¬λ°κ³Ό **λ™μΌν• λ΅μ§**μΌλ΅ `ArrayBuffer`λ¥Ό λ³µνΈν™”ν•μ—¬ MediaSourceμ— μ£Όμ…ν•λ‹¤. λ‹¨, λ„¤νΈμ›ν¬ μ¤λ¥κ°€ μ—†μΌλ―€λ΅ μ²­ν¬ μ¬μ‹λ„ λ΅μ§μ€ λ™μ‘ν•μ§€ μ•μΌλ©°, λ³µνΈν™” μ‹¤ν¨λ” μ¦‰μ‹ `error-fatal`λ΅ μ΄μ–΄μ§„λ‹¤.

---

## 3. λ™μ  μ›ν„°λ§ν‚Ή (v5.3 μ‹ κ·)

-   **λ©μ :** μ μ¶ λ°©μ§€κ°€ μ•„λ‹ **μ μ¶ μ‹ μ±…μ„ μ¶”μ **μ„ μ„ν• μ–µμ μ±….
-   **Seed μƒμ„±:** μ„λ²„λ” `SHA256(userId + videoId + deviceId)`λ¥Ό ν†µν•΄ μ¶”μ μ΄ κ°€λ¥ν•μ§€λ§ κ°μΈμ •λ³΄λ” μ§μ ‘ λ…Έμ¶λμ§€ μ•λ” `watermarkSeed`λ¥Ό μƒμ„±ν•μ—¬ ν‚¤/λΌμ΄μ„ μ¤μ™€ ν•¨κ» μ „λ‹¬ν•λ‹¤.
-   **ν΄λΌμ΄μ–ΈνΈ λ λ”λ§:** ν”λ μ΄μ–΄λ” λΉ„λ””μ¤ μ„μ— λ³„λ„μ HTML `<canvas>` λλ” `<div>` λ μ΄μ–΄λ¥Ό μƒμ„±ν•κ³ , μ „λ‹¬λ°›μ€ `seed`μ™€ ν„μ¬ μ‹κ°„ λ“±μ„ μ΅°ν•©ν•μ—¬ λ°ν¬λ… μ›ν„°λ§ν¬λ¥Ό λ™μ μΌλ΅ λ λ”λ§ν•λ‹¤. μ΄λ” λΉ„λ””μ¤ λ°μ΄ν„° μμ²΄λ¥Ό μμ •ν•μ§€ μ•μΌλ―€λ΅ μ„±λ¥ μ €ν•κ°€ κ±°μ μ—†λ‹¤.
-   **μ„ν— μ μ‘ν• κ°•λ„:** μ„λ²„λ” μ¬μƒ μ”μ²­ μ‹ μ‚¬μ©μμ κ³„μ • μƒνƒ λ“±μ„ νλ‹¨ν•μ—¬ `watermarkMode`('normal' | 'aggressive')λ¥Ό ν•¨κ» μ „λ‹¬ν•  μ μλ‹¤. ν΄λΌμ΄μ–ΈνΈλ” μ΄ λ¨λ“μ— λ”°λΌ μ›ν„°λ§ν¬μ ν¬λ…λ„, λ°λ³µ λΉλ„, μ΄λ™ μ†λ„λ¥Ό μ΅°μ ν•μ—¬ UXμ™€ λ³΄μ•μ κ· ν•μ„ λ§μ¶λ‹¤.
-   **μ¤ν”„λΌμΈ κ°•μ  μ μ©:** μ¤ν”„λΌμΈ μ¬μƒ μ‹μ—λ” μ›ν„°λ§ν¬ λ λ”λ§ μ‹¤ν¨λ¥Ό μΉλ…μ μΈ μ¤λ¥λ΅ κ°„μ£Όν•μ—¬, μ¦‰μ‹ μ¬μƒμ„ μ¤‘λ‹¨ν•κ³  `error-fatal` μƒνƒλ΅ μ „ν™ν•λ‹¤.

---

## 4. μµμΆ… Player State Machine (v5.3)

μ¤ν”„λΌμΈ κ΄€λ ¨ μƒνƒκ°€ μ¶”κ°€λμ–΄ λ¨λ“  μ¬μƒ μ‹λ‚λ¦¬μ¤μ— λ€μ‘ν•λ‹¤.

```typescript
type PlayerState =
  | 'idle'
  // Online
  | 'requesting-key'    // μ¨λΌμΈ μ„Έμ… ν‚¤ μ”μ²­
  | 'downloading'         // (μ¨λΌμΈ) μ¤ν”„μ…‹ λ§µ λλ” μ²­ν¬ λ‹¤μ΄λ΅λ“
  | 'buffering-seek'      // (μ¨λΌμΈ) νƒμƒ‰ ν›„ λ²„νΌλ§
  // Offline
  | 'offline-downloading' // μ¤ν”„λΌμΈμ© νμΌ λ‹¤μ΄λ΅λ“ μ¤‘
  | 'offline-ready'       // μ¤ν”„λΌμΈ νμΌ μ¬μƒ μ¤€λΉ„ μ™„λ£
  | 'offline-playing'     // μ¤ν”„λΌμΈ μ¬μƒ μ¤‘
  // Common
  | 'decrypting'          // (Worker) λ³µνΈν™” μ§„ν–‰ μ¤‘
  | 'ready'               // μ¬μƒ κ°€λ¥ (λ²„νΌ λ°μ΄ν„° μ¶©λ¶„)
  | 'playing'             // (μ¨λΌμΈ) μ¬μƒ μ¤‘
  | 'paused'
  | 'recovering'          // (μ¨λΌμΈ) λ„¤νΈμ›ν¬/μ²­ν¬ μλ™ λ³µκµ¬ μ‹λ„
  | 'error-fatal'         // λ³µκµ¬ λ¶κ°€ μ¤λ¥
  | 'error-retryable'     // μ‚¬μ©μ μ¬μ‹λ„ κ°€λ¥ μ¤λ¥
  | 'license-expired';    // μ¤ν”„λΌμΈ λΌμ΄μ„ μ¤ λ§λ£
```

---

## 5. μ¥μ•  μ‹λ‚λ¦¬μ¤ λ° UX μ „λµ (v5.3 κΈ°μ¤€)

**μ›μΉ™:** β‘  λ¬΄ν• λ΅λ”© μ λ€ κΈμ§€ β‘΅ ν•­μƒ λ…ν™•ν• μƒνƒ ν”Όλ“λ°± β‘Ά μλ™ λ³µκµ¬ μ°μ„ , μ‹¤ν¨ μ‹ λ…ν™•ν• ν–‰λ™ μ λ„

| μ¥μ•  μ ν• | μ‹λ‚λ¦¬μ¤ | κ°μ§€ μ„μΉ | μ‚¬μ©μ UX | PlayerState | μλ™ λ€μ‘ (v5.3) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **μ¤νΈλ¦¬λ°** | λ‹¨μΌ μ²­ν¬ μ†μƒ | Worker (decrypt) | π”„ β€λ°μ΄ν„° λ³µκµ¬ μ¤‘β€¦β€ | `recovering` | ν•΄λ‹Ή μ²­ν¬ μµλ€ 2ν μ¬μ”μ²­ |
| | μ²­ν¬ λ³µκµ¬ μµμΆ… μ‹¤ν¨ | Main Thread | β β€νμΌ μΌλ¶€κ°€ μ†μƒλ¨β€ | `error-fatal` | μ¬μƒ μ¤‘λ‹¨ |
| **λ„¤νΈμ›ν¬** | Signed URL λ§λ£ | Worker (fetch) | π”„ β€μ—°κ²° κ°±μ‹  μ¤‘β€¦β€ | `recovering` | μƒ URL/ν‚¤ μλ™ μ¬λ°κΈ‰ |
| **μ•”νΈν™”/ν‚¤**| **ν‚¤ μ¤μ½”ν”„ λ¶μΌμΉ** | **Worker (μ‹μ‘ μ‹)** | β β€μλ»λ μ¬μƒ κ¶ν•β€ | **`error-fatal`** | **μ¦‰μ‹ μ¤‘λ‹¨ (ν‚¤ μ¤μ©)** |
| **μ¤ν”„λΌμΈ**| **λΌμ΄μ„ μ¤ λ§λ£** | **Player (μ‹μ‘ μ‹)** | β° β€μ¤ν”„λΌμΈ μ‹μ²­ κΈ°κ°„ λ§λ£β€ | **`license-expired`** | **μ¬μƒ μ°¨λ‹¨, μ¬λ‹¤μ΄λ΅λ“ μ•λ‚΄** |
| | μ €μ¥ κ³µκ°„ λ¶€μ΅± | `saveVideo` | π’Ύ β€κΈ°κΈ° μ €μ¥ κ³µκ°„ λ¶€μ΅±β€ | `error-retryable`| λ‹¤μ΄λ΅λ“ μ¤‘λ‹¨ |
| | **μ›ν„°λ§ν¬ λ λ” μ‹¤ν¨** | Player (UI) | β β€λ³΄μ• λ¨λ“ μ¤λ¥β€ | **`error-fatal`** | **(μ¤ν”„λΌμΈ μ‹) μ¦‰μ‹ μ¤‘λ‹¨** |

---

## 6. λ³΄μ• κ²½κ³„ μ„ μ–Έ (Security Boundary)

-   **λ³Έ μ‹μ¤ν…μ΄ λ°©μ–΄ν•λ” κ²ƒ (DEFENDED):**
    -   **ν‚¤ μ¬μ‚¬μ© λ°©μ§€:** μ¨λΌμΈ/μ¤ν”„λΌμΈ ν‚¤μ λ…ν™•ν• μ¤μ½”ν”„ λ¶„λ¦¬.
    -   **νμΌ κ³µμ  λ¬΄λ ¥ν™”:** λ‹¤μ΄λ΅λ“λ `.lsv` νμΌμ€ ν•΄λ‹Ή κΈ°κΈ°μ λΌμ΄μ„ μ¤ μ—†μ΄λ” λ¬΄μλ―Έν•¨.
    -   **λΌμ΄μ„ μ¤ λ³µμ  λ°©μ§€:** λΌμ΄μ„ μ¤κ°€ λ””λ°”μ΄μ¤ IDμ— λ°”μΈλ”©λ¨.
    -   **λ€κ·λ¨ μλ™ μ¶”μ¶ μ–µμ :** λ¨λ“  μ ‘κ·Όμ€ μΈμ¦ λ° λ‹¨κΈ° μ ν¨ ν† ν°/URLμ„ μ”κµ¬ν•¨.
    -   **μ μ¶ μ‹ μ±…μ„ μ¶”μ :** λ™μ  μ›ν„°λ§ν¬λ¥Ό ν†µν•΄ μ μ¶μ μ‹λ³„ κ°€λ¥μ„±μ„ μ κ³µν•¨.

-   **λ³Έ μ‹μ¤ν…μ΄ λ°©μ–΄ν•μ§€ μ•λ” κ²ƒ (NOT DEFENDED):**
    -   **ν™”λ©΄ λ…Ήν™” (Screen Recording):** λΈλΌμ°μ € λ λ²¨μ—μ„ ν™”λ©΄ λ…Ήν™”λ¥Ό μ›μ²μ μΌλ΅ λ§‰μ„ μ μ—†μ (μ΄λ” μƒμ© DRMμ μμ—­).
    -   **λ©”λ¨λ¦¬ λ¤ν”„ κ³µκ²© (Memory Dump):** μ™λ ¨λ κ³µκ²©μκ°€ λΈλΌμ°μ € λ©”λ¨λ¦¬λ¥Ό λ¶„μ„ν•μ—¬ λ³µνΈν™”λ λΉ„λ””μ¤ ν”„λ μ„μ΄λ‚ μ„Έμ… ν‚¤λ¥Ό νƒμ·¨ν•  κ°€λ¥μ„±μ„ λ°°μ ν•  μ μ—†μ.
    -   **λ£¨ν…/νƒμ¥ κΈ°κΈ°μ—μ„μ λ³΄νΈ:** λ³€μ΅°λ μ΄μμ²΄μ  ν™κ²½μ—μ„μ λ³΄μ•μ„ λ³΄μ¥ν•μ§€ μ•μ.

**κ²°λ΅ :** v5.3μ€ μƒμ© DRM μ†”λ£¨μ…μ„ λ„μ…ν•κΈ° μ „, μ›Ή ν‘μ¤€ κΈ°μ (Web Crypto, IndexedDB) λ‚΄μ—μ„ κµ¬ν„ν•  μ μλ” μµκ³  μμ¤€μ **λ³΄μ• μ–µμ μ±…(Deterrent)** μ΄λ‹¤.
