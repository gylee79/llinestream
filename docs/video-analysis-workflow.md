
# [μµμΆ…] λΉ„λ””μ¤ μ²λ¦¬, λ³΄μ• μ¬μƒ λ° μ¤ν”„λΌμΈ μ›ν¬ν”λ΅μ° (v5.0)

**λ©ν‘:** κ΄€λ¦¬μκ°€ λΉ„λ””μ¤λ¥Ό μ—…λ΅λ“ν•λ” μκ°„λ¶€ν„° μµμΆ… μ‚¬μ©μκ°€ μ¨λΌμΈ/μ¤ν”„λΌμΈμ—μ„ λκΉ€ μ—†μ΄ μ•μ „ν•κ² μ‹μ²­ν•κΈ°κΉμ§€μ μ „ κ³Όμ •μ„ μλ™ν™”ν•©λ‹λ‹¤. **μ•μ •μ„±μ΄ λ€ν­ ν–¥μƒλ Chunked μ¤νΈλ¦¬λ°**κ³Ό λ™μ  μ›ν„°λ§ν¬ κΈ°μ λ΅ μ½ν…μΈ λ¥Ό λ³΄νΈν•λ” μ„λ²„λ¦¬μ¤ νμ΄ν”„λΌμΈμ…λ‹λ‹¤.

**ν•µμ‹¬ κΈ°μ  μ¤νƒ (v5.0 κΈ°μ¤€):**
- **AI λ¨λΈ:** `gemini-1.5-flash-preview`
- **νμΌ μ•”νΈν™”:** **Chunked AES-256-GCM-V3 with Length Header & AAD** (μ¤νΈλ¦¬λ° μ•μ •μ„± κ·Ήλ€ν™”)
- **λ§μ¤ν„° ν‚¤ μ•”νΈν™”:** ν™κ²½λ³€μ/Secret Manager κΈ°λ° **KEK(Key Encryption Key)**
- **μ„Έμ… ν‚¤ μ•”νΈν™”:** **HKDF-SHA256 (RFC 5869)** (ν‘μ¤€ν™”λ `info` κ°’ μ‚¬μ©)
- **μ‹¤ν–‰ ν™κ²½:** Firebase Cloud Functions (v2)
- **λ°μ΄ν„°λ² μ΄μ¤:** Firestore
- **νμΌ μ €μ¥μ†:** Firebase Storage
- **ν΄λΌμ΄μ–ΈνΈ:** React (Next.js), **Web Worker**, **Web Crypto API**, Media Source Extensions (MSE)
- **ν΄λΌμ΄μ–ΈνΈ DB:** IndexedDB (μ¤ν”„λΌμΈ μ €μ¥μ©)

---

## Part 1. λΉ„λ””μ¤ μ—…λ΅λ“ λ° μλ™ μ²λ¦¬ (κ΄€λ¦¬μ)

κ΄€λ¦¬μκ°€ λΉ„λ””μ¤λ¥Ό μ—…λ΅λ“ν•λ©΄, μ•„λ κ³Όμ •μ΄ λ°±κ·ΈλΌμ΄λ“μ—μ„ μλ™μΌλ΅ μ§„ν–‰λ©λ‹λ‹¤.

1.  **λ©”νƒ€λ°μ΄ν„° μ…λ ¥ λ° νμΌ μ„ νƒ (`video-upload-dialog.tsx`)**
    κ΄€λ¦¬μκ°€ λΉ„λ””μ¤ μ λ©, μ„¤λ… λ“±μ„ μ…λ ¥ν•κ³  μ›λ³Έ λΉ„λ””μ¤ νμΌμ„ μ„ νƒν•©λ‹λ‹¤.

2.  **νμΌ μ—…λ΅λ“ λ° μ •λ³΄ μ €μ¥ (`upload-episode.ts`)**
    λΈλΌμ°μ €κ°€ μ§μ ‘ Firebase Storageμ— λΉ„λ””μ¤ νμΌμ„ μ—…λ΅λ“ν•©λ‹λ‹¤. μ—…λ΅λ“κ°€ μ™„λ£λλ©΄, νμΌ κ²½λ΅μ™€ λ©”νƒ€λ°μ΄ν„°λ¥Ό Firestoreμ `episodes` μ»¬λ ‰μ…μ— **`status.processing: 'pending'`** μƒνƒλ΅ μ €μ¥ν•μ—¬ λ°±μ—”λ“ ν”„λ΅μ„Έμ¤λ¥Ό κΉ¨μ›λ‹λ‹¤.

3.  **λ°±μ—”λ“ ν”„λ΅μ„Έμ¤ νΈλ¦¬κ±° (`functions/src/index.ts`)**
    `pending` μƒνƒμ μƒ μ—ν”Όμ†λ“ λ¬Έμ„κ°€ μƒμ„±λλ©΄, Cloud Functionμ `onDocumentWritten` νΈλ¦¬κ±°κ°€ μ‹¤ν–‰λ©λ‹λ‹¤. ν•¨μλ” μ¦‰μ‹ μƒνƒλ¥Ό `'processing'`μΌλ΅ λ³€κ²½ν•μ—¬ μ¤‘λ³µ μ‹¤ν–‰μ„ λ°©μ§€ν•©λ‹λ‹¤.

4.  **AI λ¶„μ„ λ° μ•”νΈν™” λ³‘λ ¬ μ²λ¦¬ (`functions/src/index.ts`)**
    λ‘ κ°€μ§€ ν•µμ‹¬ μ‘μ—…μ΄ `Promise.allSettled`λ¥Ό ν†µν•΄ λ™μ‹μ— μ‹μ‘λ©λ‹λ‹¤.
    *   **μ‘μ—… A: AI μ½ν…μΈ  λ¶„μ„ (`runAiAnalysis`):**
        *   **κΈ°μ :** `gemini-1.5-flash-preview`
        *   **κ³Όμ •:** μ›λ³Έ λΉ„λ””μ¤ νμΌμ„ λ¶„μ„ν•μ—¬ μ”μ•½, μ „μ²΄ λ€λ³Έ, νƒ€μ„λΌμΈ λ“±μ„ ν¬ν•¨ν• JSON λ°μ΄ν„°λ¥Ό μƒμ„±ν•©λ‹λ‹¤. λ€λ³Έ(`.txt`)κ³Ό μλ§‰(`.vtt`)μ€ λ³„λ„ νμΌλ΅ Storageμ— μ €μ¥ν•κ³ , λ‚λ¨Έμ§€λ” Firestore λ¬Έμ„μ `aiGeneratedContent` ν•„λ“μ— μ €μ¥ν•©λ‹λ‹¤.
        *   **μƒνƒ λ¶„λ¦¬:** μ΄ μ‘μ—…μ΄ μ‹¤ν¨ν•λ”λΌλ„ λΉ„λ””μ¤ μ•”νΈν™” λ° μ¬μƒμ—λ” μν–¥μ„ μ£Όμ§€ μ•μµλ‹λ‹¤. `aiProcessingStatus` ν•„λ“λ΅ μƒνƒλ¥Ό λ³„λ„ κ΄€λ¦¬ν•λ©°, κ΄€λ¦¬μ νμ΄μ§€μ—μ„ μ¬μ‹λ„ν•  μ μμµλ‹λ‹¤.

    *   **μ‘μ—… B: μ²­ν¬ κΈ°λ° μ•”νΈν™” (`createEncryptedFile`)**
        *   **κΈ°μ :** Node.js `crypto`, **Chunked AES-256-GCM-V3 (with Length Header & AAD)**
        *   **κ³Όμ •:**
            1. ν™κ²½λ³€μ λλ” Secret Managerμ—μ„ **KEK(Key Encryption Key)**λ¥Ό μ•μ „ν•κ² λ΅λ“ν•©λ‹λ‹¤.
            2. λΉ„λ””μ¤ ν•λ‚λ‹Ή μ μΌλ¬΄μ΄ν• **`λ§μ¤ν„° μ•”νΈν™” ν‚¤`(AES-256)**μ™€ **`μ†”νΈ(Salt)`**λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
            3. μ›λ³Έ λΉ„λ””μ¤ νμΌμ„ **1MB λ‹¨μ„μ μ²­ν¬(chunk)λ΅** λ‚λ„μ–΄ μμ°¨μ μΌλ΅ μ²λ¦¬ν•©λ‹λ‹¤.
            4. **κ° μ²­ν¬λ§λ‹¤** μƒλ΅μ΄ **12λ°”μ΄νΈ `IV`(μ΄κΈ°ν™” λ²΅ν„°)**λ¥Ό μƒμ„±ν•κ³ , **μ²­ν¬ μΈλ±μ¤**λ¥Ό AAD(Additional Authenticated Data)λ΅ μ„¤μ •ν•μ—¬ μ¬μ •λ ¬ κ³µκ²©μ„ λ°©μ§€ν•©λ‹λ‹¤.
            5. λ§μ¤ν„° ν‚¤λ¥Ό μ‚¬μ©ν•΄ μ²­ν¬λ¥Ό μ•”νΈν™”ν• λ’¤ **16λ°”μ΄νΈ `μΈμ¦ νƒκ·Έ(Auth Tag)`**λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
            6. **[v5.0 ν•µμ‹¬]** μ•”νΈν™”λ κ° μ²­ν¬ μ•μ—, **μ²­ν¬μ μ „μ²΄ κΈΈμ΄(IV+λ°μ΄ν„°+Tag)λ¥Ό λ‚νƒ€λ‚΄λ” 4λ°”μ΄νΈ ν—¤λ”**λ¥Ό μ¶”κ°€ν•©λ‹λ‹¤.
            7. μµμΆ…μ μΌλ΅ **`[κΈΈμ΄(4)][IV(12)][μ•”νΈν™”λ λ°μ΄ν„°...][μΈμ¦ νƒκ·Έ(16)]`** κµ¬μ΅°μ μ²­ν¬λ“¤μ„ κ³„μ† μ΄μ–΄ λ¶™μ—¬ μµμΆ… μ•”νΈν™” νμΌ(`.lsv`)μ„ μ™„μ„±ν•©λ‹λ‹¤.
            8. μµμΆ… νμΌμ„ λΉ„κ³µκ° κ²½λ΅(`episodes/{episodeId}/encrypted.lsv`)μ— μ—…λ΅λ“ν•©λ‹λ‹¤.
            9. μƒμ„±λ **λ§μ¤ν„° ν‚¤**λ¥Ό **KEKλ΅ λ‹¤μ‹ μ•”νΈν™”**ν•μ—¬ `video_keys` μ»¬λ ‰μ…μ `vidkey_{episodeId}` λ¬Έμ„μ— `encryptedMasterKey` ν•„λ“λ΅ μ•μ „ν•κ² λ³΄κ΄€ν•©λ‹λ‹¤. μ΄ μ»¬λ ‰μ…μ€ μ„λ²„λ§ μ ‘κ·Ό κ°€λ¥ν•©λ‹λ‹¤.

5.  **μµμΆ… κ²°κ³Ό μ €μ¥ λ° μ •λ¦¬**
    λ‘ μ‘μ—…μ΄ μ™„λ£λλ©΄, AI λ¶„μ„ κ²°κ³Ό νμΌ κ²½λ΅, μ•”νΈν™”λ λΉ„λ””μ¤ νμΌ κ²½λ΅ λ° λ©”νƒ€λ°μ΄ν„°(`encryption.version: 3`)λ¥Ό λ¨λ‘ Firestoreμ ν•΄λ‹Ή μ—ν”Όμ†λ“ λ¬Έμ„μ— μ—…λ°μ΄νΈν•κ³  μƒνƒλ¥Ό `'completed'`λ΅ λ³€κ²½ν•©λ‹λ‹¤. λ§μ§€λ§‰μΌλ΅, μ›λ³Έ λΉ„λ””μ¤ νμΌμ„ μ‚­μ ν•μ—¬ μ €μ¥ κ³µκ°„μ„ μ μ•½ν•κ³  λ³΄μ•μ„ κ°•ν™”ν•©λ‹λ‹¤.

---

## Part 2. λ³΄μ• μ¨λΌμΈ μ¤νΈλ¦¬λ° (μ‚¬μ©μ)

1.  **λ³΄μ• URL λ°κΈ‰ μ”μ²­ (`video-player-dialog.tsx` β†’ `/api/video-url`)**
    ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ— `videoId`μ™€ μΈμ¦ ν† ν°μ„ λ³΄λ‚΄ λΉ„κ³µκ° μ•”νΈν™” νμΌ(`.lsv`)μ— 5λ¶„κ°„ μ ‘κ·Όν•  μ μλ” **μ„λ…λ URL(Signed URL)**μ„ λ°κΈ‰λ°›μµλ‹λ‹¤.

2.  **μ¬μƒ μ„Έμ… λ° μ„μ‹ ν‚¤ μ”μ²­ (`video-player-dialog.tsx` β†’ `/api/play-session`)**
    ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ— `videoId`μ™€ `deviceId`λ¥Ό λ³΄λ‚΄ μ¬μƒ μ„Έμ…μ„ μ”μ²­ν•©λ‹λ‹¤. μ‘λ‹µμ—λ” **μ„Έμ… ν‚¤μ λ§λ£ μ‹κ°„**κ³Ό **ν‚¤μ μ‚¬μ© λ©μ (scope)**μ΄ ν¬ν•¨λ©λ‹λ‹¤.

3.  **μ„Έμ… ν‚¤(Derived Key) μƒμ„± (μ„λ²„, `/api/play-session/route.ts`)**
    *   **κΈ°μ :** Node.js `crypto.hkdf` (**HKDF-SHA256**)
    *   **κ³Όμ •:**
        1. μ„λ²„λ” `video_keys` κΈκ³ μ—μ„ ν•΄λ‹Ή λΉ„λ””μ¤μ **μ•”νΈν™”λ λ§μ¤ν„° ν‚¤(`encryptedMasterKey`)**μ™€ **`μ†”νΈ`**λ¥Ό κΊΌλƒ…λ‹λ‹¤.
        2. KEKλ¥Ό μ΄μ©ν•΄ `encryptedMasterKey`λ¥Ό λ³µνΈν™”ν•μ—¬ μ›λ³Έ λ§μ¤ν„° ν‚¤λ¥Ό λ©”λ¨λ¦¬μ—λ§ λ΅λ“ν•©λ‹λ‹¤.
        3. κ°€μ Έμ¨ λ§μ¤ν„° ν‚¤, μ†”νΈ, κ·Έλ¦¬κ³  ν‘μ¤€ν™”λ `info` κ°’μ„ **HKDF-SHA256 μ•κ³ λ¦¬μ¦**μ— μ…λ ¥ν•μ—¬ **μ¤μ§ μ΄ μ„Έμ…μ—μ„λ§ μ ν¨ν• μΌνμ„± `μ„Έμ… ν‚¤(Derived Key)`**λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
            *   **ν‘μ¤€ `info` κµ¬μ΅°:** `Buffer.concat([Buffer.from("LSV_ONLINE_V1"), ...])`
        4. μƒμ„±λ μ„Έμ… ν‚¤, λ§λ£ μ •λ³΄, μ¤μ½”ν”„(`ONLINE_STREAM_ONLY`)λ¥Ό ν΄λΌμ΄μ–ΈνΈμ— μ „λ‹¬ν•©λ‹λ‹¤.

4.  **μ²­ν¬ λ‹¨μ„ λ³µνΈν™” λ° μ¬μƒ (ν΄λΌμ΄μ–ΈνΈ, `crypto.worker.ts`)**
    *   **κΈ°μ :** **Web Worker**, **Web Crypto API (`crypto.subtle.decrypt`)**, Media Source Extensions (MSE)
    *   **μ¬μƒ λ°©μ‹ (Prefetch-after-download):**
        1. **μ•μ •μ„± μµμ°μ„ :** ν„μ¬ κµ¬ν„μ€ Web Workerκ°€ μ•”νΈν™”λ `.lsv` νμΌ μ „μ²΄λ¥Ό λ¨Όμ € λ‹¤μ΄λ΅λ“ν•©λ‹λ‹¤. μ΄ λ°©μ‹μ€ κµ¬ν„μ΄ λ‹¨μν•κ³  λ””λ²„κΉ…μ΄ μ©μ΄ν•λ©°, λ„¤νΈμ›ν¬ ν™κ²½μ΄ λ¶μ•μ •ν•  λ• κ°€μ¥ μ•μ •μ μΈ μ¬μƒμ„ λ³΄μ¥ν•©λ‹λ‹¤.
        2. **λ―Έλ ν™•μ¥μ„±:** ν–¥ν›„ μ²« N MBλ§ λ¨Όμ € λ‹¤μ΄λ΅λ“ λ° λ³µνΈν™”ν•μ—¬ μ¬μƒμ„ μ‹μ‘ν•κ³ , λ‚λ¨Έμ§€λ” λ°±κ·ΈλΌμ΄λ“μ—μ„ μμ°¨μ μΌλ΅ μ²λ¦¬ν•λ” **'ν”„λ¦¬ν¨μΉ μ¤νΈλ¦¬λ°'** λ°©μ‹μΌλ΅ κ°μ„ ν•μ—¬ μ΄κΈ° λ΅λ”© μ†λ„λ¥Ό λ”μ± λ‹¨μ¶•ν•  μ μμµλ‹λ‹¤.
    *   **λ³µνΈν™” κ³Όμ •:**
        1. λ©”μΈ μ¤λ λ“λ” λ°κΈ‰λ°›μ€ μ„λ…λ URLκ³Ό μ„Έμ… ν‚¤λ¥Ό **Web Worker(λ°±κ·ΈλΌμ΄λ“ μ¤λ λ“)λ΅ μ „λ‹¬**ν•©λ‹λ‹¤.
        2. Web Workerλ” `.lsv` νμΌ λ²„νΌλ¥Ό μμ°¨μ μΌλ΅ μ²λ¦¬ν•©λ‹λ‹¤.
        3. **[v5.0 ν•µμ‹¬]** κ° μ²­ν¬λ§λ‹¤ **4λ°”μ΄νΈ `κΈΈμ΄ ν—¤λ”`λ¥Ό λ¨Όμ € μ½μ–΄** ν•΄λ‹Ή μ²­ν¬μ μ •ν™•ν• ν¬κΈ°λ¥Ό νμ•…ν•©λ‹λ‹¤.
        4. ν•΄λ‹Ή κΈΈμ΄λ§νΌμ λ°μ΄ν„°μ—μ„ **`IV`λ¥Ό μ¶”μ¶**ν•κ³ , μ²­ν¬ μΈλ±μ¤λ¥Ό AADλ΅ μ„¤μ •ν• λ’¤ λ‚λ¨Έμ§€ λ¶€λ¶„(**μ•”νΈν™”λ λ°μ΄ν„° + μΈμ¦ νƒκ·Έ**)μ„ λ³µνΈν™”ν•©λ‹λ‹¤.
        5. λ¨λ“  μ²­ν¬μ λ³µνΈν™”κ°€ μ„±κ³µν•λ©΄, **ν•λ‚λ΅ ν•©μ³μ§„ μ™„μ „ν• λΉ„λ””μ¤ νμΌ(MP4)**μ„ λ©”μΈ μ¤λ λ“λ΅ μ „μ†΅ν•©λ‹λ‹¤.
        6. λ©”μΈ μ¤λ λ“λ” λ³µνΈν™”λ μ „μ²΄ λΉ„λ””μ¤ νμΌμ„ `MediaSource` λ²„νΌμ— μ£Όμ…ν•κ³ , HTML5 `<video>` μ”μ†λ” μ΄λ¥Ό μ¬μƒν•©λ‹λ‹¤. μ΄ λ°©μ‹μ€ μ™„μ „ν• μ¤νΈλ¦¬λ°μ€ μ•„λ‹μ§€λ§, μ²­ν¬ λ‹¨μ„ κ²€μ¦μ„ ν†µν•΄ λ°μ΄ν„° μ†μƒ μ‹ **λΉ λ¥Έ μ‹¤ν¨(fail-fast)**λ¥Ό μ λ„ν•μ—¬ λ¬΄ν• λ΅λ”©μ„ λ°©μ§€ν•κ³  μ¬μƒ μ•μ •μ„±μ„ κ·Ήλ€ν™”ν•©λ‹λ‹¤.

---

## Part 3. λ³΄μ• μ¤ν”„λΌμΈ λ‹¤μ΄λ΅λ“ λ° μ¬μƒ (μ‚¬μ©μ)

1.  **μ©λ‰ ν™•μΈ λ° λΌμ΄μ„ μ¤ μ”μ²­ (`lib/offline-db.ts` β†’ `/api/offline-license`)**
    μ‚¬μ©μκ°€ λ‹¤μ΄λ΅λ“ λ²„νΌμ„ ν΄λ¦­ν•λ©΄, ν΄λΌμ΄μ–ΈνΈλ” λ¨Όμ € `navigator.storage.estimate()`λ¥Ό μ‚¬μ©ν•΄ κΈ°κΈ°μ μ”μ—¬ μ €μ¥ κ³µκ°„μ„ ν™•μΈν•©λ‹λ‹¤. κ³µκ°„μ΄ μ¶©λ¶„ν•λ©΄, μ„λ²„μ— `videoId`μ™€ `deviceId`λ¥Ό μ „μ†΅ν•μ—¬ μ¤ν”„λΌμΈ λΌμ΄μ„ μ¤λ¥Ό μ”μ²­ν•©λ‹λ‹¤.

2.  **μ¤ν”„λΌμΈ ν‚¤ μƒμ„± (μ„λ²„, `/api/offline-license/route.ts`)**
    μ„λ²„λ” κµ¬λ… κ¶ν•μ„ ν™•μΈν•κ³ , λ§μ¤ν„° ν‚¤λ¥Ό κ°€μ Έμµλ‹λ‹¤. μ΄λ²μ—λ” **λ§λ£ μ‹κ°„(μ: 7μΌ ν›„)μ„ ν¬ν•¨**ν•κ³  **`LSV_OFFLINE_V1`** μ ‘λ‘μ‚¬λ¥Ό μ‚¬μ©ν• ν‘μ¤€ `info` κ°’μΌλ΅ **HKDF μ•κ³ λ¦¬μ¦**μ„ μ‹¤ν–‰ν•μ—¬ **μ¤ν”„λΌμΈμ© μ„Έμ… ν‚¤**λ¥Ό μƒμ„±ν•©λ‹λ‹¤.

3.  **λΌμ΄μ„ μ¤ λ°κΈ‰ λ° μ €μ¥ (`lib/offline-db.ts`)**
    μ„λ²„λ” `μ¤ν”„λΌμΈμ© μ„Έμ… ν‚¤`, `λ§λ£ μ‹κ°„`, `μ›ν„°λ§ν¬ μ‹λ“`λ¥Ό ν¬ν•¨ν• **μ¤ν”„λΌμΈ λΌμ΄μ„ μ¤**λ¥Ό ν΄λΌμ΄μ–ΈνΈμ— μ „λ‹¬ν•©λ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈλ” μ•”νΈν™”λ `.lsv` νμΌ μ „μ²΄μ™€ μ΄ λΌμ΄μ„ μ¤λ¥Ό ν•¨κ» λΈλΌμ°μ €μ `IndexedDB`μ— μ•μ „ν•κ² μ €μ¥ν•©λ‹λ‹¤.

4.  **μ¤ν”„λΌμΈ μ¬μƒ (`downloads/page.tsx` & `video-player-dialog.tsx`)**
    μ‚¬μ©μκ°€ μ¤ν”„λΌμΈ μƒνƒμ—μ„ λ‹¤μ΄λ΅λ“ν• μμƒμ„ μ¬μƒν•λ©΄, μ•±μ€ `IndexedDB`μ—μ„ μ•”νΈν™”λ λΉ„λ””μ¤μ™€ λΌμ΄μ„ μ¤λ¥Ό λ¶λ¬μµλ‹λ‹¤. λΌμ΄μ„ μ¤μ `λ§λ£ μ‹κ°„`μ„ ν™•μΈν• ν›„, **Web Worker**κ°€ μ €μ¥λ `μ¤ν”„λΌμΈμ© μ„Έμ… ν‚¤`λ¥Ό μ‚¬μ©ν•μ—¬ **μ²­ν¬ λ‹¨μ„λ΅ μ‹¤μ‹κ°„ λ³µνΈν™”**ν•λ©° μ¬μƒν•©λ‹λ‹¤.

---

## Part 4. μ›ν„°λ§ν¬ λ° λ³΄μ• κ³ μ§€

*   **μ›ν„°λ§ν¬ μ²λ¦¬ λ°©μ‹:**
    *   **λ©μ :** μ΄ μ›ν„°λ§ν¬λ” μ μ¶μ„ λ°©μ§€ν•λ” κΈ°μ μ΄ μ•„λ‹λΌ, **μ μ¶ λ°μƒ μ‹ μµμ΄ μ ν¬μλ¥Ό μ¶”μ **ν•κΈ° μ„ν• **μ–µμ (Deterrent)** μλ‹¨μ…λ‹λ‹¤.
    *   **μ‹λ“ μƒμ„±:** μ¨λΌμΈ/μ¤ν”„λΌμΈ ν‚¤λ¥Ό λ°κΈ‰ν•  λ•, μ„λ²„λ” `μ‚¬μ©μ ID`λ¥Ό ν•΄μ‹±ν•μ—¬ κ³ μ ν• **`μ›ν„°λ§ν¬ μ‹λ“`** λ¬Έμμ—΄μ„ μƒμ„±ν•μ—¬ ν‚¤μ™€ ν•¨κ» μ „λ‹¬ν•©λ‹λ‹¤.
    *   **λ™μ  λ λ”λ§ (`video-player-dialog.tsx`):** λΉ„λ””μ¤ ν”λ μ΄μ–΄λ” μ „λ‹¬λ°›μ€ `μ›ν„°λ§ν¬ μ‹λ“`λ¥Ό λΉ„λ””μ¤ μ„μ— μ—¬λ¬ κ° λ³µμ ν•μ—¬ ν¬λ―Έν•κ², κ·Έλ¦¬κ³  λ¶κ·μΉ™ν•κ² μ›€μ§μ΄λ” μ¤λ²„λ μ΄λ΅ ν‘μ‹ν•©λ‹λ‹¤.
    *   **ν•κ³„:** ν™”λ©΄ λ…Ήν™” ν›„ ν¬λ΅­, ν•„ν„°λ§ λ“±μΌλ΅ μ κ±°λ  μ μμµλ‹λ‹¤.

*   **λ³΄μ• μμ¤€ κ³ μ§€:**
    *   λ³Έ μ‹μ¤ν…μ€ μƒμ© DRM(Widevine, FairPlay) μ†”λ£¨μ…μ΄ μ•„λ‹λ©°, Web Crypto APIλ¥Ό κΈ°λ°μΌλ΅ ν•©λ‹λ‹¤. λ”°λΌμ„ λ©”λ¨λ¦¬ λ¤ν”„, μ½”λ“ λ³€μ΅° λ“±μ μ „λ¬Έμ μΈ κ³µκ²©μΌλ΅λ¶€ν„° μ™„λ²½ν•κ² μ•μ „ν•μ§€λ” μ•μµλ‹λ‹¤. λ³Έ μ•„ν‚¤ν…μ²λ” μ¶”κ°€ λΉ„μ© μ—†μ΄ κµ¬ν„ν•  μ μλ” **μµλ€ν•μ λ³΄μ• μμ¤€μ„ μ μ©ν•μ—¬, μΌλ°μ μΈ μ‚¬μ©μ λ° λΉ„μ „λ¬Έκ°€μ— μν• μ½ν…μΈ  λ¶λ²• λ³µμ λ¥Ό ν¨κ³Όμ μΌλ΅ μ–µμ **ν•λ” κ²ƒμ„ λ©ν‘λ΅ ν•©λ‹λ‹¤.

---

## Part 5. μ¥μ•  μ‹λ‚λ¦¬μ¤ λ° UX μ „λµ (v5.0)

**μ›μΉ™:** β‘  λ¬΄ν• λ΅λ”© κΈμ§€ β‘΅ ν•­μƒ μ‚¬μ©μμ—κ² μƒν™© κ³ μ§€ β‘Ά λ³µκµ¬ κ°€λ¥ν• μ¤λ¥λ” μλ™, λ¶κ°€λ¥ν• μ¤λ¥λ” λ…ν™•ν• μ„ νƒμ§€ μ κ³µ.

| μ¥μ•  μ ν• | μ‹λ‚λ¦¬μ¤ | κ°μ§€ μ„μΉ | μ‚¬μ©μ UX | μλ™ λ€μ‘ |
| :--- | :--- | :--- | :--- | :--- |
| **λ„¤νΈμ›ν¬** | Signed URL λ§λ£ | Worker fetch (403) | π”„ β€μ—°κ²° κ°±μ‹  μ¤‘β€¦β€ | μƒ URL μλ™ μ”μ²­ |
| | λ„¤νΈμ›ν¬ λκΉ€ | Worker fetch (Error) | π“΅ β€λ„¤νΈμ›ν¬κ°€ λ¶μ•μ •ν•©λ‹λ‹¤β€ | 3ν μ§€μ λ°±μ¤ν”„ μ¬μ‹λ„ |
| **μ•”νΈν™” μ²λ¦¬** | **Length Header μ†μƒ** | Worker | νμΌ μ†μƒ | β β€νμΌμ΄ μ†μƒλμ—μµλ‹λ‹¤β€ | μ¦‰μ‹ μ¤‘λ‹¨ (Fail-fast) |
| | **Auth Tag λ¶μΌμΉ** | Worker decrypt | λ¬΄κ²°μ„± μ‹¤ν¨ | β β€μ¬μƒ λ¶κ°€(λ³΄μ• μ¤λ¥)β€ | μ¬μΈμ¦ λ° μ¬μ”μ²­ |
| **ν‚¤/μ„Έμ…** | μ„Έμ… ν‚¤ λ§λ£ | Worker | TTL μ΄κ³Ό | π” β€λ³΄μ• μ„Έμ… κ°±μ‹  μ¤‘β€ | μƒ ν‚¤ μλ™ μ”μ²­ |
| | KEK λ΅λ“ μ‹¤ν¨ | Cloud Function | (μ‚¬μ©μμ—κ² λ„λ‹¬ μ• ν•¨) | ν•¨μ μ‹¤ν–‰ μ¤‘λ‹¨ | κ΄€λ¦¬μ μ•λ¦Ό(SRE) |
| **ν”λ μ΄μ–΄** | MSE/μ½”λ± λ―Έμ§€μ› | Main Thread | π§© β€λΈλΌμ°μ € λ―Έμ§€μ›β€ | Fallback μ•λ‚΄ | - |
| | Worker λΉ„μ •μƒ μΆ…λ£ | Main Thread | Crash | π”„ β€μ¬μƒ λ³µκµ¬ μ¤‘β€ | Worker μ¬μƒμ„± |
| **μ¤ν”„λΌμΈ** | μ €μ¥ κ³µκ°„ λ¶€μ΅± | `saveVideo` | π’Ύ β€κ³µκ°„ λ¶€μ΅±β€ | λ‹¤μ΄λ΅λ“ μ¤‘λ‹¨ | - |
| | λΌμ΄μ„ μ¤ λ§λ£ | `getDownloadedVideo` | β° β€λ‹¤μ΄λ΅λ“ λ§λ£β€ | μ¬μΈμ¦/μ¬λ‹¤μ΄λ΅λ“ μ•λ‚΄ | - |

**ν”λ μ΄μ–΄ μƒνƒ λ¨Έμ‹  (UX κµ¬ν„ κ¶μ¥):**
```typescript
type PlayerState =
  | 'idle'
  | 'requesting-key'
  | 'downloading'
  | 'decrypting'
  | 'ready'
  | 'playing'
  | 'paused'
  | 'recovering' // μλ™ λ³µκµ¬ μ‹λ„ μ¤‘
  | 'error-fatal' // λ³µκµ¬ λ¶κ°€λ¥
  | 'error-retryable'; // μ‚¬μ©μ μ¬μ‹λ„ κ°€λ¥
```

---

## Part 6. μ›ν¬ν”λ΅μ° μ”μ•½ (JSON)

```json
{
  "workflow": "LlineStream Video Processing & Playback",
  "version": "5.0-Robust-Chunked",
  "parts": [
    {
      "name": "Part 1: Video Upload & Backend Processing",
      "actor": "Admin",
      "steps": [
        {
          "step": 4,
          "description": "AI analysis and file encryption run in parallel. AI failure does not block encryption.",
          "file": "functions/src/index.ts",
          "technicalDetails": {
            "aiAnalysis": {
              "model": "gemini-1.5-flash-preview",
              "statusField": "aiProcessingStatus",
              "retryable": "Yes, via admin panel."
            },
            "fileEncryption": {
              "library": "Node.js Crypto",
              "algorithm": "AES-256-GCM-CHUNKED-V3",
              "chunkSize": "1MB",
              "lsvChunkFormat": {
                "description": "The .lsv file is a concatenation of self-describing encrypted chunks for robust streaming.",
                "layout": "[ChunkLength(4B)][IV(12B)][Ciphertext(N)][AuthTag(16B)]...repeat",
                "integrity": "Each chunk's index is used as Additional Authenticated Data (AAD) to prevent reordering attacks."
              },
              "keyManagement": {
                "description": "A unique Master Key is generated per video, encrypted with a KEK (loaded from env/Secret Manager), and stored in the 'video_keys' collection."
              }
            }
          }
        }
      ]
    },
    {
      "name": "Part 2: Encrypted Video Playback (Online/Offline)",
      "actor": "User",
      "steps": [
        {
          "step": 7,
          "description": "Server generates a session-specific derived key using standardized HKDF, including a purpose prefix.",
          "file": "src/app/api/play-session/route.ts",
          "technicalDetails": {
            "keyDerivation": "HKDF-SHA256(masterKey, salt, Buffer.concat([Buffer.from('LSV_ONLINE_V1' | 'LSV_OFFLINE_V1'), ...]))",
            "response": "Includes derived key, its expiration time, and scope."
          }
        },
        {
          "step": 9,
          "description": "A Web Worker downloads the encrypted file and decrypts it chunk by chunk, verifying integrity at each step.",
          "file": "src/workers/crypto.worker.ts",
          "technicalDetails": {
            "decryption": "Uses Web Crypto API (AES-GCM). It processes the stream by first reading a 4-byte length header, then decrypting the specified chunk. This prevents full-stream failure from partial data corruption and enables stable seeking."
          }
        }
      ]
    }
  ]
}
```
