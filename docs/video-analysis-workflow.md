# [공식] 비디오 처리, 보안 재생 및 오프라인 워크플로우 (v5.1.x)

**목표:** 관리자가 비디오를 업로드하는 순간부터 최종 사용자가 온라인/오프라인에서 끊김 없이 안전하게 시청하기까지의 전 과정을 자동화합니다. **안정성이 대폭 향상된 Chunked 스트리밍**과 동적 워터마크 기술로 콘텐츠를 보호하는 서버리스 파이프라인입니다.

---

## 1. 버전 히스토리

- **v5.1.x (Current):** 안정성 강화 패치
  - `v5.1.9` Worker 생명주기 및 복구 규칙 정의
  - `v5.1.8` 청크 복호화 실패 시 Fail-Fast 정책 강제
  - `v5.1.7` Signed URL 및 세션 키 Race Condition 방지 규칙 적용
  - `v5.1.6` Seek 안정성 범위 명문화 및 강제
  - `v5.1.5` AI 분석 실패 비차단 처리 및 재시도 공식화
  - `v5.1.3` 온라인/오프라인 키 스코프(Scope) 충돌 방지
  - `v5.1.2` 복호화 실패 상태 전이 규칙 정의
  - `v5.1.1` Seek 안정성 기반 마련 (문서화)
- **v5.0:** 스트리밍 아키텍처 교체 (Robust Chunked AES-GCM v5.0 도입), KEK 로딩 로직 개선
- **v4.0:** 보안 강화 (KEK 기반 마스터 키 암호화, HKDF 표준화)
- **~v3.0:** 초기 암호화 및 재생 파이프라인 구축

---

## 2. Chunked AES-GCM이 UX 안정성을 만드는 구조적 이유

기존에는 전체 파일을 단일 암호화하여, 1GB 영상의 99%를 받아도 마지막 1%가 손상되면 전체 재생이 불가능했습니다. v5.0 아키텍처는 이 문제를 구조적으로 해결합니다.

-   **설계:** 암호화된 파일(`.lsv`)은 독립적으로 해독 가능한 `청크(Chunk)`들의 연속입니다. 각 청크는 `[청크 길이(4B)][IV(12B)][암호화된 데이터...][인증 태그(16B)]` 구조를 가집니다.
-   **작동 방식:**
    1.  **명시적 경계:** Web Worker는 먼저 4바이트의 `길이 헤더`를 읽어 이번에 처리할 청크의 정확한 크기를 인지합니다.
    2.  **정확한 읽기:** 네트워크 스트림에서 정확히 해당 길이만큼의 데이터만 버퍼로 가져와 처리합니다.
    3.  **독립적 해독:** 각 청크는 고유의 IV와 인증 태그를 가지므로, 다른 청크의 상태와 관계없이 독립적으로 복호화가 가능합니다.
-   **안정성 확보:**
    -   **Seek 안정성 (v5.1.6):** 현재 구현은 안정성을 최우선으로 하여 전체 파일을 다운로드한 후 재생합니다. **(Prefetch-after-download)**. 이 방식은 구현이 단순하고 디버깅이 용이하며, 네트워크 환경이 불안정할 때 가장 안정적인 재생을 보장합니다. **사용자는 `ready` 상태가 되기 전까지는 비디오를 탐색할 수 없습니다.** 이는 부분 데이터만 있는 상태에서 탐색을 시도하여 발생할 수 있는 복잡한 오류를 원천 차단합니다.
    -   **네트워크 중단 복구:** 다운로드 중 연결이 끊겨도, 이전에 성공적으로 받은 청크들까지는 안전하게 버퍼에 저장되어 있으므로, 연결이 재개되면 중단된 지점부터 다시 다운로드를 이어갈 수 있습니다.
    -   **오류 국소화 (Fail-Fast, v5.1.8):** 만약 특정 청크 하나가 손상되어 인증 태그(Auth Tag) 검증에 실패하면, 플레이어는 즉시 이를 `error-fatal` 상태로 인지하고 재생을 중단하며 "파일 손상" 메시지를 표시합니다. 이는 **'알 수 없는 무한 로딩' 현상을 근본적으로 방지**하고 사용자에게 명확한 피드백을 제공합니다.

---

## 3. 최종 Player State Machine (v5.1.x)

```typescript
type PlayerState =
  | 'idle'             // 초기 상태
  | 'requesting-key'   // 세션 키 요청 중
  | 'downloading'      // .lsv 파일 다운로드 중 (진행률 표시)
  | 'decrypting'       // 다운로드된 청크 복호화 중 (진행률 표시)
  | 'ready'            // 재생 준비 완료 (버퍼에 데이터 있음)
  | 'playing'          // 재생 중
  | 'paused'           // 일시정지
  | 'recovering'       // 일시적 오류(네트워크 등) 자동 복구 시도 중
  | 'error-fatal'      // 복구 불가능한 치명적 오류 (e.g., 파일 손상)
  | 'error-retryable'; // 사용자 재시도 가능 오류
```

---

## 4. 장애 시나리오 및 UX 전략 (v5.1.x 기준)

**원칙:** ① 무한 로딩 금지 ② 항상 사용자에게 상황 고지 ③ 복구 가능한 오류는 자동, 불가능한 오류는 명확한 선택지 제공.

| 장애 유형 | 시나리오 | 감지 위치 | 사용자 UX | PlayerState | 자동 대응 (v5.1.9) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **네트워크** | Signed URL 만료 | Worker (fetch 전) | 🔄 “연결 갱신 중…” | `recovering` | 새 URL 자동 요청 (메인 스레드) |
| | 네트워크 끊김 | Main Thread fetch | 📡 “네트워크가 불안정합니다” | `recovering` | 3회 지수 백오프 재시도 |
| **암호화 처리** | **Auth Tag 불일치** | **Worker (decrypt)** | ❌ “재생 불가(보안 오류)” | **`error-fatal`** | **즉시 중단 (재시도 없음)** |
| | **Length Header 손상** | Worker | ❌ “파일이 손상되었습니다” | **`error-fatal`** | **즉시 중단 (재시도 없음)** |
| **키/세션** | **세션 키 만료/무효** | **Worker (시작 시)** | 🔐 “보안 세션 갱신 중” | `recovering` | **새 키 자동 요청 (메인 스레드)** |
| | **키 스코프 불일치** | **Worker (시작 시)** | ❌ “권한 확인 실패” | **`error-fatal`** | **즉시 중단 (키 오용)** |
| **Worker** | Worker 비정상 종료 | Main Thread (Crash) | 🔄 “재생 엔진 복구 중” | `recovering` | **Worker 재생성 (최대 1회)** |

---

## 5. 보안 및 기타

-   **보안 수준 고지:** 본 시스템은 상용 DRM(Widevine, FairPlay) 솔루션이 아니며, Web Crypto API를 기반으로 합니다. 메모리 덤프 등의 전문적인 공격으로부터 완벽하게 안전하지는 않으며, 일반적인 사용자에 의한 콘텐츠 불법 복제를 효과적으로 **억제(Deterrent)**하는 것을 목표로 합니다.
-   **워터마크 처리 방식:**
    *   **목적:** 이 워터마크는 유출을 방지하는 기술이 아니라, **유출 발생 시 최초 유포자를 추적**하기 위한 **억제(Deterrent)** 수단입니다.
    *   **시드 생성:** 온라인/오프라인 키를 발급할 때, 서버는 `사용자 ID`를 해싱하여 고유한 **`워터마크 시드`** 문자열을 생성하여 키와 함께 전달합니다.
    *   **동적 렌더링 (`video-player-dialog.tsx`):** 비디오 플레이어는 전달받은 `워터마크 시드`를 비디오 위에 여러 개 복제하여 희미하게, 그리고 불규칙하게 움직이는 오버레이로 표시합니다.
