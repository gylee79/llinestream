
# [ê³µì‹] ë¹„ë””ì˜¤ ì²˜ë¦¬, ë³´ì•ˆ ìž¬ìƒ ë° ì˜¤í”„ë¼ì¸ ì›Œí¬í”Œë¡œìš° (v5.2)

**ëª©í‘œ:** v5.1ì—ì„œ í™•ë³´í•œ ì•ˆì •ì„±ì„ ê¸°ë°˜ìœ¼ë¡œ, **ì¦‰ì‹œ ìž¬ìƒ(True Streaming Seek)**ê³¼ **ë¶€ë¶„ ë³µêµ¬(Partial Recovery)** ê¸°ëŠ¥ì„ ë„ìž…í•˜ì—¬ ì‚¬ìš©ìž ê²½í—˜ì„ ê·¹ëŒ€í™”í•˜ê³ , ì˜¤í”„ë¼ì¸ ë¼ì´ì„ ìŠ¤ë¥¼ ì•”í˜¸í•™ì ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë³´ì•ˆì„ ì™„ì„±í•©ë‹ˆë‹¤.

---

## 1. ë²„ì „ ížˆìŠ¤í† ë¦¬

- **v5.2 (Current): True Streaming & Partial Recovery**
  - `v5.2.4` (êµ¬í˜„) ì˜¤í”„ë¼ì¸ ë¼ì´ì„ ìŠ¤ í‚¤ ìŠ¤ì½”í”„ ì •ì‹ ë¶„ë¦¬ ë° ê²€ì¦
  - `v5.2.3` (êµ¬í˜„) ë‹¨ì¼ ì²­í¬ ì†ìƒ ì‹œ ë¶€ë¶„ ë³µêµ¬(ìž¬ì‹œë„) ë¡œì§ ë„ìž…
  - `v5.2.2` (êµ¬í˜„) `buffering-seek` ìƒíƒœ ì¶”ê°€ ë° í”Œë ˆì´ì–´ UX í™•ìž¥
  - `v5.2.1` (êµ¬í˜„) HTTP Range ìš”ì²­ ê¸°ë°˜ Chunk-on-Demand ìŠ¤íŠ¸ë¦¬ë° ë„ìž…
- **v5.1.x:** ì•ˆì •ì„± ê°•í™” íŒ¨ì¹˜
  - `v5.1.9` Worker ìƒëª…ì£¼ê¸° ë° ë³µêµ¬ ê·œì¹™ ì •ì˜
  - `v5.1.8` ì²­í¬ ë³µí˜¸í™” ì‹¤íŒ¨ ì‹œ Fail-Fast ì •ì±… ê°•ì œ
  - `v5.1.7` Signed URL ë° ì„¸ì…˜ í‚¤ Race Condition ë°©ì§€ ê·œì¹™ ì ìš©
  - `v5.1.6` Seek ì•ˆì •ì„± ë²”ìœ„ ëª…ë¬¸í™” ë° ê°•ì œ (Prefetch-after-download)
- **v5.0:** ìŠ¤íŠ¸ë¦¬ë° ì•„í‚¤í…ì²˜ êµì²´ (Robust Chunked AES-GCM)
- **v4.0:** ë³´ì•ˆ ê°•í™” (KEK ê¸°ë°˜ ë§ˆìŠ¤í„° í‚¤ ì•”í˜¸í™”, HKDF í‘œì¤€í™”)

---

## 2. v5.2 ì•„í‚¤í…ì²˜ í•µì‹¬ ë³€ê²½ì : ì¦‰ì‹œ ìž¬ìƒ (True Streaming)

v5.1ì´ **ì•ˆì •ì„±**ì„ ìœ„í•´ `Prefetch-after-download` (ì „ì²´ ë‹¤ìš´ë¡œë“œ í›„ ìž¬ìƒ) ë°©ì‹ì„ íƒí–ˆë‹¤ë©´, v5.2ëŠ” v5.1ì—ì„œ ì™„ì„±ëœ `Length-Prefixed Chunk` êµ¬ì¡°ë¥¼ 100% í™œìš©í•˜ì—¬ **ì‚¬ìš©ìž ê²½í—˜(UX)ì„ ê·¹ëŒ€í™”**í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì§„í™”í•©ë‹ˆë‹¤.

- **v5.1:** [ì „ì²´ íŒŒì¼ ë‹¤ìš´ë¡œë“œ] â†’ [ì „ì²´ íŒŒì¼ ë³µí˜¸í™”] â†’ [ìž¬ìƒ ì‹œìž‘] (ì´ˆê¸° ëŒ€ê¸° ì‹œê°„ ê¹€)
- **v5.2:** [í•„ìš”í•œ ì²­í¬ë§Œ Range ìš”ì²­] â†’ [í•´ë‹¹ ì²­í¬ë§Œ ë³µí˜¸í™”] â†’ [ì¦‰ì‹œ ìž¬ìƒ ë° ë²„í¼ë§] (ì´ˆê¸° ëŒ€ê¸° ì‹œê°„ ëŒ€í­ ë‹¨ì¶•)

```
[Client App] --(Seek to 5:00)--> [Video Player Dialog]
     |                                    |
     | (1. Calculate Chunk Index)         v
     |                             [Player State = 'buffering-seek']
     |                                    |
     | (2. Abort existing worker tasks)   v
     +<-----(3. Request new chunk)---- [Web Worker] --(4. HTTP Range Request)--> [Storage (.lsv)]
                                          | (Range: bytes=chunk_start-chunk_end)
                                          |
     (6. Append to MediaSource) <---(5. Decrypt Chunk)
             |
             v
     [Video Element plays from 5:00]
```

### 2.1. Chunk Offset Map: ì¦‰ì‹œ ìž¬ìƒì˜ í•µì‹¬ ì—´ì‡ 

True Streamingì„ êµ¬í˜„í•˜ê¸° ìœ„í•´, í”Œë ˆì´ì–´ëŠ” ì´ì œ ì „ì²´ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ëŒ€ì‹  **ì²­í¬ ì˜¤í”„ì…‹ ë§µ(Chunk Offset Map)**ì„ ë¨¼ì € êµ¬ì¶•í•©ë‹ˆë‹¤.

1.  **ì´ˆê¸° ìš”ì²­:** í”Œë ˆì´ì–´ëŠ” `.lsv` íŒŒì¼ì˜ **ì•žë¶€ë¶„ ìˆ˜ KBë§Œ** ë¨¼ì € ìš”ì²­í•©ë‹ˆë‹¤.
2.  **ë§µ ìƒì„±:** WorkerëŠ” ìˆ˜ì‹ í•œ ë°ì´í„°ì—ì„œ ê° ì²­í¬ì˜ **`[ê¸¸ì´ í—¤ë”(4B)]`**ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì½ì–´, ê° ì²­í¬ì˜ `ì‹œìž‘ ë°”ì´íŠ¸(byteStart)`ì™€ `ë ë°”ì´íŠ¸(byteEnd)`ë¥¼ ê³„ì‚°í•˜ì—¬ ë©”ëª¨ë¦¬ì— `Offset Map`ì„ ìƒì„±í•©ë‹ˆë‹¤.
3.  **ìž¬ìƒ ì‹œìž‘:** ë§µì´ ì™„ì„±ë˜ë©´, WorkerëŠ” ë©”ì¸ ìŠ¤ë ˆë“œì— `INIT_SUCCESS`ë¥¼ ì•Œë¦¬ê³ , ë©”ì¸ ìŠ¤ë ˆë“œëŠ” `ì²­í¬ 0`ë¶€í„° ë°ì´í„° ìš”ì²­ì„ ì‹œìž‘í•©ë‹ˆë‹¤.

ì´ `Offset Map` ë•ë¶„ì— í”Œë ˆì´ì–´ëŠ” ì „ì²´ íŒŒì¼ì„ ë°›ì§€ ì•Šê³ ë„, ì›í•˜ëŠ” ì‹œê°„ëŒ€ì— í•´ë‹¹í•˜ëŠ” ì²­í¬ì˜ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì•Œê³  HTTP Range ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

### 2.2. íƒìƒ‰(Seek) ë° ë¶€ë¶„ ë³µêµ¬(Partial Recovery) ì‹œë‚˜ë¦¬ì˜¤

-   **íƒìƒ‰ ì‹œ:** ì‚¬ìš©ìžê°€ íƒ€ìž„ë¼ì¸ì„ 5ë¶„ìœ¼ë¡œ ì´ë™ì‹œí‚¤ë©´, í”Œë ˆì´ì–´ëŠ” `5ë¶„`ì— í•´ë‹¹í•˜ëŠ” `chunkIndex`ë¥¼ ê³„ì‚°í•˜ì—¬ Workerì— í•´ë‹¹ ì²­í¬ë¶€í„° ë‹¤ì‹œ ìš”ì²­í•©ë‹ˆë‹¤. WorkerëŠ” ì§„í–‰ ì¤‘ì´ë˜ ë‹¤ìš´ë¡œë“œë¥¼ ì·¨ì†Œí•˜ê³  ìƒˆ ìš”ì²­ì„ ì¦‰ì‹œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
-   **ë¶€ë¶„ ë³µêµ¬:** ìŠ¤íŠ¸ë¦¬ë° ì¤‘ íŠ¹ì • ì²­í¬ í•˜ë‚˜ê°€ ì†ìƒë˜ì–´ ë³µí˜¸í™”(Auth Tag ê²€ì¦)ì— ì‹¤íŒ¨í•˜ë”ë¼ë„, v5.1ì²˜ëŸ¼ ì¦‰ì‹œ `error-fatal`ë¡œ ì¢…ë£Œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹ , WorkerëŠ” `RECOVERABLE_CHUNK_ERROR`ë¥¼ ë³´ê³ í•˜ê³ , ë©”ì¸ ìŠ¤ë ˆë“œëŠ” **í•´ë‹¹ ì²­í¬ë§Œ ìµœëŒ€ 2íšŒê¹Œì§€ ìžë™ìœ¼ë¡œ ìž¬ìš”ì²­**í•©ë‹ˆë‹¤. 2íšŒ ìž¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í•˜ë©´, ê·¸ ë•Œ `error-fatal`ë¡œ ì „í™˜í•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ìž¥í•©ë‹ˆë‹¤.

---

## 3. Player State Machine (v5.2)

`buffering-seek`ì™€ `license-expired` ìƒíƒœê°€ ì¶”ê°€ë˜ì–´, ëª¨ë“  ìž¬ìƒ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€ì‘í•©ë‹ˆë‹¤.

```typescript
type PlayerState =
  | 'idle'
  | 'requesting-key'
  | 'downloading'      // Offset Map êµ¬ì„± ë˜ëŠ” ì´ˆê¸° ì²­í¬ ë‹¤ìš´ë¡œë“œ
  | 'decrypting'       // ìˆ˜ì‹ ëœ ì²­í¬ ë³µí˜¸í™” ì¤‘ (ë‹¨ê³„ë³„ UI)
  | 'buffering-seek'   // íƒìƒ‰ í›„ í•„ìš”í•œ ì²­í¬ ë²„í¼ë§ ì¤‘
  | 'ready'            // ìž¬ìƒ ê°€ëŠ¥ (ë²„í¼ì— ë°ì´í„° ì¶©ë¶„)
  | 'playing'
  | 'paused'
  | 'recovering'       // ì²­í¬ ìž¬ì‹œë„ ë˜ëŠ” í‚¤/URL ìž¬ë°œê¸‰ ì¤‘
  | 'error-fatal'      // ë³µêµ¬ ë¶ˆê°€ (íŒŒì¼ ì†ìƒ, í‚¤ ìŠ¤ì½”í”„ ì˜¤ë¥˜ ë“±)
  | 'error-retryable'
  | 'license-expired'; // ì˜¤í”„ë¼ì¸ ë¼ì´ì„ ìŠ¤ ë§Œë£Œ
```

---

## 4. ì˜¤í”„ë¼ì¸ ë¼ì´ì„ ìŠ¤ ë° í‚¤ ìŠ¤ì½”í”„ ì •ì‹ ë¶„ë¦¬ (v5.2.4)

v5.1ì˜ ì•”ë¬µì  ì²˜ë¦¬ë¥¼ ê°œì„ í•˜ì—¬, ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ í‚¤ì˜ ì—­í• ì„ ì•”í˜¸í•™ì ìœ¼ë¡œ ëª…í™•ížˆ ë¶„ë¦¬í•©ë‹ˆë‹¤.

-   **í‚¤ íŒŒìƒ(HKDF) ì‹œ `info` ê°’ ë¶„ë¦¬:**
    -   **ì˜¨ë¼ì¸ í‚¤:** `info = "LSV_ONLINE_V1" + userId + deviceId + sessionId`
    -   **ì˜¤í”„ë¼ì¸ í‚¤:** `info = "LSV_OFFLINE_V1" + userId + deviceId + expiresAt`
-   **API ì‘ë‹µ:** `/api/play-session`ì€ `scope: "ONLINE_STREAM_ONLY"`ë¥¼, `/api/offline-license`ëŠ” `scope: "OFFLINE_PLAYBACK"`ì„ ì‘ë‹µì— ëª…ì‹œì ìœ¼ë¡œ í¬í•¨í•©ë‹ˆë‹¤.
-   **Worker ê²€ì¦:** WorkerëŠ” ìž¬ìƒ ì‹œìž‘ ì „, í˜„ìž¬ ì»¨í…ìŠ¤íŠ¸(ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸)ì™€ ì „ë‹¬ë°›ì€ í‚¤ì˜ `scope`ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. ë¶ˆì¼ì¹˜ ì‹œ, ë³µí˜¸í™”ë¥¼ ì‹œë„í•˜ì§€ ì•Šê³  ì¦‰ì‹œ `error-fatal` ìƒíƒœë¡œ ì „í™˜í•˜ì—¬ í‚¤ ì˜¤ìš©ì„ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤.

---

## 5. ìž¥ì•  ì‹œë‚˜ë¦¬ì˜¤ ë° UX ì „ëžµ (v5.2 ê¸°ì¤€)

**ì›ì¹™:** â‘  ë¬´í•œ ë¡œë”© ì ˆëŒ€ ê¸ˆì§€ â‘¡ í•­ìƒ ëª…í™•í•œ ìƒíƒœ í”¼ë“œë°± â‘¢ ìžë™ ë³µêµ¬ ìš°ì„ , ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ í–‰ë™ ìœ ë„

| ìž¥ì•  ìœ í˜• | ì‹œë‚˜ë¦¬ì˜¤ | ê°ì§€ ìœ„ì¹˜ | ì‚¬ìš©ìž UX | PlayerState | ìžë™ ëŒ€ì‘ (v5.2) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **ìŠ¤íŠ¸ë¦¬ë°** | **íƒìƒ‰(Seek)** | **Video Element** | â³ â€œì´ë™ ì¤‘â€¦â€ | **`buffering-seek`** | **í•„ìš”í•œ ì²­í¬ë§Œ Range ìš”ì²­** |
| | **ë‹¨ì¼ ì²­í¬ ì†ìƒ** | **Worker (decrypt)** | ðŸ”„ â€œë°ì´í„° ë³µêµ¬ ì¤‘â€¦â€ | **`recovering`** | **í•´ë‹¹ ì²­í¬ ìµœëŒ€ 2íšŒ ìž¬ìš”ì²­** |
| | ì²­í¬ ë³µêµ¬ ìµœì¢… ì‹¤íŒ¨ | Main Thread | âŒ â€œíŒŒì¼ ì¼ë¶€ê°€ ì†ìƒë¨â€ | `error-fatal` | ìž¬ìƒ ì¤‘ë‹¨ |
| **ë„¤íŠ¸ì›Œí¬** | Signed URL ë§Œë£Œ | Worker (fetch) | ðŸ”„ â€œì—°ê²° ê°±ì‹  ì¤‘â€¦â€ | `recovering` | ìƒˆ URL ìžë™ ìš”ì²­ |
| | ë„¤íŠ¸ì›Œí¬ ëŠê¹€ | Worker (fetch) | ðŸ“¡ â€œë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¶ˆì•ˆì •â€ | `recovering` | 3íšŒ ì§€ìˆ˜ ë°±ì˜¤í”„ ìž¬ì‹œë„ |
| **ì•”í˜¸í™”/í‚¤** | Auth Tag ë¶ˆì¼ì¹˜ | Worker (decrypt) | ðŸ”„ â€œë°ì´í„° ë³µêµ¬ ì¤‘â€¦â€ | `recovering` | ì†ìƒëœ ì²­í¬ë¡œ ê°„ì£¼, ìž¬ì‹œë„ |
| | **í‚¤ ìŠ¤ì½”í”„ ë¶ˆì¼ì¹˜** | **Worker (ì‹œìž‘ ì‹œ)** | âŒ â€œê¶Œí•œ í™•ì¸ ì‹¤íŒ¨â€ | **`error-fatal`** | **ì¦‰ì‹œ ì¤‘ë‹¨ (í‚¤ ì˜¤ìš©)** |
| | ì„¸ì…˜ í‚¤ ë§Œë£Œ | Worker (ì‹œìž‘ ì‹œ) | ðŸ” â€œë³´ì•ˆ ì„¸ì…˜ ê°±ì‹  ì¤‘â€ | `recovering` | ìƒˆ í‚¤ ìžë™ ìš”ì²­ |
| **ì˜¤í”„ë¼ì¸** | **ë¼ì´ì„ ìŠ¤ ë§Œë£Œ** | **Player (ì‹œìž‘ ì‹œ)** | â° â€œë‹¤ìš´ë¡œë“œ ê¸°ê°„ ë§Œë£Œâ€ | **`license-expired`** | **ìž¬ìƒ ì°¨ë‹¨, ìž¬ë‹¤ìš´ë¡œë“œ ì•ˆë‚´** |
| | ì €ìž¥ ê³µê°„ ë¶€ì¡± | `saveVideo` | ðŸ’¾ â€œì €ìž¥ ê³µê°„ ë¶€ì¡±â€ | `error-retryable` | ë‹¤ìš´ë¡œë“œ ì¤‘ë‹¨ |

---

## 6. ë³´ì•ˆ ë° ê¸°íƒ€

-   **ì›Œí„°ë§ˆí¬ ì²˜ë¦¬ ë°©ì‹ (v5.2.5 ì œì•ˆ):** `aggressive` ëª¨ë“œë¥¼ ì¶”ê°€í•˜ì—¬, ê³ ìœ„í—˜ ê³„ì •ìœ¼ë¡œ íŒë‹¨ë  ê²½ìš° ë” ë¹ˆë²ˆí•˜ê³  ìž˜ ë³´ì´ëŠ” ì›Œí„°ë§ˆí¬ë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
-   **ë³´ì•ˆ ìˆ˜ì¤€ ê³ ì§€:** ë³¸ ì‹œìŠ¤í…œì€ ìƒìš© DRM ì†”ë£¨ì…˜ì´ ì•„ë‹ˆë©°, Web Crypto APIë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤. ë©”ëª¨ë¦¬ ë¤í”„ ë“±ì˜ ì „ë¬¸ì ì¸ ê³µê²©ìœ¼ë¡œë¶€í„° ì™„ë²½í•˜ê²Œ ì•ˆì „í•˜ì§€ëŠ” ì•Šìœ¼ë©°, ì¼ë°˜ì ì¸ ì‚¬ìš©ìžì— ì˜í•œ ì½˜í…ì¸  ë¶ˆë²• ë³µì œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ **ì–µì œ(Deterrent)**í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

    