/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for private data, while providing public read-only access to shared content like courses and categories. The primary goal is to secure user-specific information, such as profiles and subscriptions, ensuring only the authenticated owner can access or modify their own data.
 *
 * Data Structure: The data is segregated into two main categories:
 * 1. Private User Data: All data specific to a user is nested under the `/users/{userId}` path (e.g., `/users/{userId}/subscriptions`). This structure enables simple and performant path-based security rules.
 * 2. Public Content Data: Top-level collections like `/fields`, `/classifications`, and `/courses` store publicly accessible information. These collections are intended to be read by all users but managed exclusively by a backend service, hence client-side writes are disabled.
 *
 * Key Security Decisions:
 * - User Isolation: Users can only access documents within their own `/users/{userId}` data tree. Listing or viewing other users' profiles or subscriptions is strictly prohibited.
 * - Public Content is Read-Only: All content collections (`fields`, `classifications`, `courses`, `episodes`) are configured to be read-only for clients. This is a secure pattern that assumes content is managed via a trusted backend server using the Admin SDK, which bypasses these rules. This prevents unauthorized modification or deletion of shared application content.
 * - Ownership Integrity: For all user-created documents (e.g., their profile or subscriptions), rules enforce that the document data contains a `userId` field that matches the user's authenticated UID and the document's path. This field is immutable to prevent documents from being "re-assigned" to another user after creation.
 * - No User Deletion: Users are not permitted to delete their own `/users/{userId}` document directly via the client. This is a common safety measure to prevent accidental data loss and is typically handled by a managed server process.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * Use this to verify a user's ownership of a document or data path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the user is the owner and the document already exists.
     * CRITICAL: Use for all update and delete operations to prevent modifying
     * or deleting non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates required authorization fields for User creation.
     * Ensures the document ID is consistent with the user's auth UID.
     */
    function hasValidUserDataOnCreate(userId) {
      let data = request.resource.data;
      return data.id == userId;
    }
    
    /**
     * Ensures critical, immutable User fields are not changed on update.
     */
    function hasImmutableUserData() {
      let data = request.resource.data;
      return data.id == resource.data.id;
    }

    /**
     * Validates required authorization fields for Subscription creation.
     * Enforces consistency between the path and the internal userId field.
     */
    function hasValidSubscriptionDataOnCreate(userId) {
      let data = request.resource.data;
      return data.userId == userId;
    }
    
    /**
     * Ensures critical, immutable Subscription fields are not changed on update.
     */
    function hasImmutableSubscriptionData() {
      let data = request.resource.data;
      return data.userId == resource.data.userId;
    }

    // ------------------------------------------------------------------------
    // User Data Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow (create) A new user creating their own profile document: `create /users/user_abc` as user_abc.
     * @deny (get) Another user trying to read a profile: `get /users/user_abc` as user_xyz.
     * @deny (list) Any user trying to list all user profiles: `list /users`.
     * @principle Restricts access to a user's own data tree and enforces self-creation.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && hasImmutableUserData();
      allow delete: if false;
    }

    /**
     * @description Manages user subscriptions, ensuring they are private to the owner.
     * @path /users/{userId}/subscriptions/{subscriptionId}
     * @allow (create) A user creating a new subscription for themselves: `create /users/user_abc/subscriptions/sub_123` as user_abc.
     * @allow (list) A user listing their own subscriptions: `list /users/user_abc/subscriptions` as user_abc.
     * @deny (get) A user trying to read another user's subscription: `get /users/user_abc/subscriptions/sub_123` as user_xyz.
     * @principle Enforces strict document ownership within a user's private subcollection.
     */
    match /users/{userId}/subscriptions/{subscriptionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidSubscriptionDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && hasImmutableSubscriptionData();
      allow delete: if isExistingOwner(userId);
    }

    // ------------------------------------------------------------------------
    // Public Content Rules (Read-Only for Clients)
    // ------------------------------------------------------------------------

    /**
     * @description Publicly readable categories. Writes are disabled for clients.
     * @path /fields/{fieldId}
     * @allow (get) Any user, signed in or not, can read a field: `get /fields/edu_123`.
     * @deny (create) Any client trying to create a new field: `create /fields/new_field`.
     * @principle Provides public read access to application content while securing it from client modification. Content is managed by a backend service.
     */
    match /fields/{fieldId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Publicly readable classifications (genres). Writes are disabled for clients.
     * @path /classifications/{classificationId}
     * @allow (get) Any user, signed in or not, can read a classification: `get /classifications/coding_456`.
     * @deny (update) Any client trying to change a classification's price: `update /classifications/coding_456`.
     * @principle Provides public read access to application content while securing it from client modification. Content is managed by a backend service.
     */
    match /classifications/{classificationId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    /**
     * @description Publicly readable courses. Writes are disabled for clients.
     * @path /courses/{courseId}
     * @allow (list) Any user, signed in or not, can list all courses: `list /courses`.
     * @deny (delete) Any client trying to delete a course: `delete /courses/react_789`.
     * @principle Provides public read access to application content while securing it from client modification. Content is managed by a backend service.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;

      /**
       * @description Publicly readable episodes within a course. Writes are disabled for clients.
       * @path /courses/{courseId}/episodes/{episodeId}
       * @allow (get) Any user, signed in or not, can read an episode: `get /courses/react_789/episodes/ep_01`.
       * @deny (create) Any client trying to add an episode: `create /courses/react_789/episodes/ep_02`.
       * @principle Provides public read access to application content while securing it from client modification. Content is managed by a backend service.
       */
      match /episodes/{episodeId} {
        allow get: if true;
        allow list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
    }
  }
}